define(["controller/controllers","libs/underscore","libs/nv.d3"],function(e,t,n){e.controller("MetricCtrl",["$scope","$http",function(r,i){r.loadMetrics=function(){i.get("/api/admin/metrics/fetch").success(function(e){r.fetchedMetrics=t.flatten(e),r.averagedMetrics=_averageMetrics(r.fetchedMetrics),r.metrics=_chooseMetrics(),_loadGraph()})},r.refresh=function(){r.loadMetrics()},r.sortTimerBy=function(e){_sortBy(e,"timerSortField","timerSortOrder")},r.sortMeterBy=function(e){_sortBy(e,"meterSortField","meterSortOrder")},r.showID=function(){return r.averageNodes?"hide-id":"show-id"},_averageObjs=function(e){var n=t.size(e);if(n==0)return{};var r={},i=t.keys(e[0]);return t.each(i,function(i){if(t.isNumber(e[0][i])){var s=t.chain(e).pluck(i).reduce(function(e,t){return e+t},0).value();r[i]=s/n}else r[i]=e[0][i]}),r},_averageMetrics=function(e){return t.chain(r.fetchedMetrics).groupBy("name").map(function(e){return _averageObjs(e)}).value()},_chooseMetrics=function(){return r.averageNodes?r.averagedMetrics:r.fetchedMetrics},_sortBy=function(e,t,n){r[t]===e?r[n]=!r[n]:r[n]=!1,r[t]=e},r.$watch("averageNodes",function(e){r.metrics=_chooseMetrics()}),r.averageNodes=!0,r.loadMetrics(),r.sortTimerBy("name"),r.sortMeterBy("count"),r.timerSortOrder=!1,r.meterSortOrder=!0,_getGraphData=function(e){var n=[],r=[],i=[];return t.chain(e).filter(function(e){switch(e.type){case"TIMER":return!0;default:return!1}}).each(function(e,t){n.push({x:t,y:e.min,units:e.durationUnit,metricName:e.name}),r.push({x:t,y:e.mean,units:e.durationUnit,metricName:e.name}),i.push({x:t,y:e.max,units:e.durationUnit,metricName:e.name})}),[{key:"Min",values:n},{key:"Average",values:r},{key:"Max",values:i}]},_loadGraph=function(){n.addGraph(function(){var e=n.models.multiBarChart();return e.showControls(!1),e.tooltipContent(function(e,t,n,r,i){return"<h3>"+r.point.metricName+"</h3>"+"<p>"+n+" "+r.point.units+"</p>"}),e.xAxis.tickFormat(d3.format(",f")),e.yAxis.tickFormat(d3.format(",.1f")),d3.select("#chart1 svg").datum(_getGraphData(r.averagedMetrics)).transition().duration(250).call(e),n.utils.windowResize(e.update),e})}}])})